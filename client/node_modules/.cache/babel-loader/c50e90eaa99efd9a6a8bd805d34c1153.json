{"ast":null,"code":"import _toConsumableArray from\"C:/garage-etude/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"C:/garage-etude/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useRef}from\"react\";import VideoContext from\"./VideoContext\";import{io}from\"socket.io-client\";import Peer from\"simple-peer\";import{message}from\"antd\";//const URL = \"http://localhost:5000/\";\nimport{jsx as _jsx}from\"react/jsx-runtime\";var SERVER_URL=\"https://garage-etude.herokuapp.com/\";export var socket=io(SERVER_URL);var VideoState=function VideoState(_ref){var children=_ref.children;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),callAccepted=_useState2[0],setCallAccepted=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),callEnded=_useState4[0],setCallEnded=_useState4[1];var _useState5=useState(),_useState6=_slicedToArray(_useState5,2),stream=_useState6[0],setStream=_useState6[1];var _useState7=useState([]),_useState8=_slicedToArray(_useState7,2),chat=_useState8[0],setChat=_useState8[1];var _useState9=useState(\"\"),_useState10=_slicedToArray(_useState9,2),name=_useState10[0],setName=_useState10[1];var _useState11=useState({}),_useState12=_slicedToArray(_useState11,2),call=_useState12[0],setCall=_useState12[1];var _useState13=useState(\"\"),_useState14=_slicedToArray(_useState13,2),me=_useState14[0],setMe=_useState14[1];var _useState15=useState(\"\"),_useState16=_slicedToArray(_useState15,2),userName=_useState16[0],setUserName=_useState16[1];var _useState17=useState(\"\"),_useState18=_slicedToArray(_useState17,2),otherUser=_useState18[0],setOtherUser=_useState18[1];var _useState19=useState(true),_useState20=_slicedToArray(_useState19,2),myVdoStatus=_useState20[0],setMyVdoStatus=_useState20[1];var _useState21=useState(),_useState22=_slicedToArray(_useState21,2),userVdoStatus=_useState22[0],setUserVdoStatus=_useState22[1];var _useState23=useState(true),_useState24=_slicedToArray(_useState23,2),myMicStatus=_useState24[0],setMyMicStatus=_useState24[1];var _useState25=useState(),_useState26=_slicedToArray(_useState25,2),userMicStatus=_useState26[0],setUserMicStatus=_useState26[1];var _useState27=useState(\"\"),_useState28=_slicedToArray(_useState27,2),msgRcv=_useState28[0],setMsgRcv=_useState28[1];var _useState29=useState(false),_useState30=_slicedToArray(_useState29,2),screenShare=_useState30[0],setScreenShare=_useState30[1];var myVideo=useRef();var userVideo=useRef();var connectionRef=useRef();var screenTrackRef=useRef();useEffect(function(){navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(function(currentStream){setStream(currentStream);myVideo.current.srcObject=currentStream;});if(localStorage.getItem(\"name\")){setName(localStorage.getItem(\"name\"));}socket.on(\"me\",function(id){return setMe(id);});socket.on(\"endCall\",function(){window.location.reload();});socket.on(\"updateUserMedia\",function(_ref2){var type=_ref2.type,currentMediaStatus=_ref2.currentMediaStatus;if(currentMediaStatus!==null||currentMediaStatus!==[]){switch(type){case\"video\":setUserVdoStatus(currentMediaStatus);break;case\"mic\":setUserMicStatus(currentMediaStatus);break;default:setUserMicStatus(currentMediaStatus[0]);setUserVdoStatus(currentMediaStatus[1]);break;}}});socket.on(\"callUser\",function(_ref3){var from=_ref3.from,callerName=_ref3.name,signal=_ref3.signal;setCall({isReceivingCall:true,from:from,name:callerName,signal:signal});});socket.on(\"msgRcv\",function(_ref4){var name=_ref4.name,value=_ref4.msg,sender=_ref4.sender;setMsgRcv({value:value,sender:sender});setTimeout(function(){setMsgRcv({});},2000);});},[]);// useEffect(() => {\n//   console.log(chat);\n// }, [chat]);\nvar answerCall=function answerCall(){setCallAccepted(true);setOtherUser(call.from);var peer=new Peer({initiator:false,trickle:false,stream:stream});peer.on(\"signal\",function(data){socket.emit(\"answerCall\",{signal:data,to:call.from,userName:name,type:\"both\",myMediaStatus:[myMicStatus,myVdoStatus]});});peer.on(\"stream\",function(currentStream){userVideo.current.srcObject=currentStream;});peer.signal(call.signal);connectionRef.current=peer;console.log(connectionRef.current);};var callUser=function callUser(id){var peer=new Peer({initiator:true,trickle:false,stream:stream});setOtherUser(id);peer.on(\"signal\",function(data){socket.emit(\"callUser\",{userToCall:id,signalData:data,from:me,name:name});});peer.on(\"stream\",function(currentStream){userVideo.current.srcObject=currentStream;});socket.on(\"callAccepted\",function(_ref5){var signal=_ref5.signal,userName=_ref5.userName;setCallAccepted(true);setUserName(userName);peer.signal(signal);socket.emit(\"updateMyMedia\",{type:\"both\",currentMediaStatus:[myMicStatus,myVdoStatus]});});connectionRef.current=peer;console.log(connectionRef.current);};var updateVideo=function updateVideo(){setMyVdoStatus(function(currentStatus){socket.emit(\"updateMyMedia\",{type:\"video\",currentMediaStatus:!currentStatus});stream.getVideoTracks()[0].enabled=!currentStatus;return!currentStatus;});};var updateMic=function updateMic(){setMyMicStatus(function(currentStatus){socket.emit(\"updateMyMedia\",{type:\"mic\",currentMediaStatus:!currentStatus});stream.getAudioTracks()[0].enabled=!currentStatus;return!currentStatus;});};//SCREEN SHARING \nvar handleScreenSharing=function handleScreenSharing(){if(!myVdoStatus){message.error(\"Turn on your video to share the content\",2);return;}if(!screenShare){navigator.mediaDevices.getDisplayMedia({cursor:true}).then(function(currentStream){var screenTrack=currentStream.getTracks()[0];// replaceTrack (oldTrack, newTrack, oldStream);\nconnectionRef.current.replaceTrack(connectionRef.current.streams[0].getTracks().find(function(track){return track.kind==='video';}),screenTrack,stream);// Listen click end\nscreenTrack.onended=function(){connectionRef.current.replaceTrack(screenTrack,connectionRef.current.streams[0].getTracks().find(function(track){return track.kind==='video';}),stream);myVideo.current.srcObject=stream;setScreenShare(false);};myVideo.current.srcObject=currentStream;screenTrackRef.current=screenTrack;setScreenShare(true);}).catch(function(error){console.log(\"No stream for sharing\");});}else{screenTrackRef.current.onended();}};//full screen\nvar fullScreen=function fullScreen(e){var elem=e.target;if(elem.requestFullscreen){elem.requestFullscreen();}else if(elem.mozRequestFullScreen){/* Firefox */elem.mozRequestFullScreen();}else if(elem.webkitRequestFullscreen){/* Chrome, Safari & Opera */elem.webkitRequestFullscreen();}else if(elem.msRequestFullscreen){/* IE/Edge */elem.msRequestFullscreen();}};var leaveCall=function leaveCall(){setCallEnded(true);connectionRef.current.destroy();socket.emit(\"endCall\",{id:otherUser});window.location.reload();};var leaveCall1=function leaveCall1(){socket.emit(\"endCall\",{id:otherUser});};var sendMsg=function sendMsg(value){socket.emit(\"msgUser\",{name:name,to:otherUser,msg:value,sender:name});var msg={};msg.msg=value;msg.type=\"sent\";msg.timestamp=Date.now();msg.sender=name;setChat([].concat(_toConsumableArray(chat),[msg]));};return/*#__PURE__*/_jsx(VideoContext.Provider,{value:{call:call,callAccepted:callAccepted,myVideo:myVideo,userVideo:userVideo,stream:stream,name:name,setName:setName,callEnded:callEnded,me:me,callUser:callUser,leaveCall:leaveCall,answerCall:answerCall,sendMsg:sendMsg,msgRcv:msgRcv,chat:chat,setChat:setChat,setMsgRcv:setMsgRcv,setOtherUser:setOtherUser,leaveCall1:leaveCall1,userName:userName,myVdoStatus:myVdoStatus,setMyVdoStatus:setMyVdoStatus,userVdoStatus:userVdoStatus,setUserVdoStatus:setUserVdoStatus,updateVideo:updateVideo,myMicStatus:myMicStatus,userMicStatus:userMicStatus,updateMic:updateMic,screenShare:screenShare,handleScreenSharing:handleScreenSharing,fullScreen:fullScreen},children:children});};export default VideoState;","map":{"version":3,"sources":["C:/garage-etude/client/src/context/VideoState.js"],"names":["React","useState","useEffect","useRef","VideoContext","io","Peer","message","SERVER_URL","socket","VideoState","children","callAccepted","setCallAccepted","callEnded","setCallEnded","stream","setStream","chat","setChat","name","setName","call","setCall","me","setMe","userName","setUserName","otherUser","setOtherUser","myVdoStatus","setMyVdoStatus","userVdoStatus","setUserVdoStatus","myMicStatus","setMyMicStatus","userMicStatus","setUserMicStatus","msgRcv","setMsgRcv","screenShare","setScreenShare","myVideo","userVideo","connectionRef","screenTrackRef","navigator","mediaDevices","getUserMedia","video","audio","then","currentStream","current","srcObject","localStorage","getItem","on","id","window","location","reload","type","currentMediaStatus","from","callerName","signal","isReceivingCall","value","msg","sender","setTimeout","answerCall","peer","initiator","trickle","data","emit","to","myMediaStatus","console","log","callUser","userToCall","signalData","updateVideo","currentStatus","getVideoTracks","enabled","updateMic","getAudioTracks","handleScreenSharing","error","getDisplayMedia","cursor","screenTrack","getTracks","replaceTrack","streams","find","track","kind","onended","catch","fullScreen","e","elem","target","requestFullscreen","mozRequestFullScreen","webkitRequestFullscreen","msRequestFullscreen","leaveCall","destroy","leaveCall1","sendMsg","timestamp","Date","now"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useRef } from \"react\";\nimport VideoContext from \"./VideoContext\";\nimport { io } from \"socket.io-client\";\nimport Peer from \"simple-peer\";\nimport { message } from \"antd\";\n\n//const URL = \"http://localhost:5000/\";\nconst SERVER_URL = \"https://garage-etude.herokuapp.com/\";\n\nexport const socket = io(SERVER_URL);\n\nconst VideoState = ({ children }) => {\n  const [callAccepted, setCallAccepted] = useState(false);\n  const [callEnded, setCallEnded] = useState(false);\n  const [stream, setStream] = useState();\n  const [chat, setChat] = useState([]);\n  const [name, setName] = useState(\"\");\n  const [call, setCall] = useState({});\n  const [me, setMe] = useState(\"\");\n  const [userName, setUserName] = useState(\"\");\n  const [otherUser, setOtherUser] = useState(\"\");\n  const [myVdoStatus, setMyVdoStatus] = useState(true);\n  const [userVdoStatus, setUserVdoStatus] = useState();\n  const [myMicStatus, setMyMicStatus] = useState(true);\n  const [userMicStatus, setUserMicStatus] = useState();\n  const [msgRcv, setMsgRcv] = useState(\"\");\n  const [screenShare, setScreenShare] = useState(false)\n\n  const myVideo = useRef();\n  const userVideo = useRef();\n  const connectionRef = useRef();\n  const screenTrackRef = useRef();\n\n  useEffect(() => {\n    navigator.mediaDevices\n      .getUserMedia({ video: true, audio: true })\n      .then((currentStream) => {\n        setStream(currentStream);\n        myVideo.current.srcObject = currentStream;\n      });\n    if (localStorage.getItem(\"name\")) {\n      setName(localStorage.getItem(\"name\"));\n    }\n    socket.on(\"me\", (id) => setMe(id));\n    socket.on(\"endCall\", () => {\n      window.location.reload();\n    });\n\n    socket.on(\"updateUserMedia\", ({ type, currentMediaStatus }) => {\n      if (currentMediaStatus !== null || currentMediaStatus !== []) {\n        switch (type) {\n          case \"video\":\n            setUserVdoStatus(currentMediaStatus);\n            break;\n          case \"mic\":\n            setUserMicStatus(currentMediaStatus);\n            break;\n          default:\n            setUserMicStatus(currentMediaStatus[0]);\n            setUserVdoStatus(currentMediaStatus[1]);\n            break;\n        }\n      }\n    });\n\n    socket.on(\"callUser\", ({ from, name: callerName, signal }) => {\n      setCall({ isReceivingCall: true, from, name: callerName, signal });\n    });\n\n    socket.on(\"msgRcv\", ({ name, msg: value, sender }) => {\n      setMsgRcv({ value, sender });\n      setTimeout(() => {\n        setMsgRcv({});\n      }, 2000);\n    });\n  }, []);\n\n  // useEffect(() => {\n  //   console.log(chat);\n  // }, [chat]);\n\n  const answerCall = () => {\n    setCallAccepted(true);\n    setOtherUser(call.from);\n    const peer = new Peer({ initiator: false, trickle: false, stream });\n\n    peer.on(\"signal\", (data) => {\n      socket.emit(\"answerCall\", {\n        signal: data,\n        to: call.from,\n        userName: name,\n        type: \"both\",\n        myMediaStatus: [myMicStatus, myVdoStatus],\n      });\n    });\n\n    peer.on(\"stream\", (currentStream) => {\n      userVideo.current.srcObject = currentStream;\n    });\n\n    peer.signal(call.signal);\n\n    connectionRef.current = peer;\n    console.log(connectionRef.current);\n  };\n\n  const callUser = (id) => {\n    const peer = new Peer({ initiator: true, trickle: false, stream });\n    setOtherUser(id);\n    peer.on(\"signal\", (data) => {\n      socket.emit(\"callUser\", {\n        userToCall: id,\n        signalData: data,\n        from: me,\n        name,\n      });\n    });\n\n    peer.on(\"stream\", (currentStream) => {\n      userVideo.current.srcObject = currentStream;\n    });\n\n    socket.on(\"callAccepted\", ({ signal, userName }) => {\n      setCallAccepted(true);\n      setUserName(userName);\n      peer.signal(signal);\n      socket.emit(\"updateMyMedia\", {\n        type: \"both\",\n        currentMediaStatus: [myMicStatus, myVdoStatus],\n      });\n    });\n\n    connectionRef.current = peer;\n    console.log(connectionRef.current);\n  };\n\n  const updateVideo = () => {\n    setMyVdoStatus((currentStatus) => {\n      socket.emit(\"updateMyMedia\", {\n        type: \"video\",\n        currentMediaStatus: !currentStatus,\n      });\n      stream.getVideoTracks()[0].enabled = !currentStatus;\n      return !currentStatus;\n    });\n  };\n\n  const updateMic = () => {\n    setMyMicStatus((currentStatus) => {\n      socket.emit(\"updateMyMedia\", {\n        type: \"mic\",\n        currentMediaStatus: !currentStatus,\n      });\n      stream.getAudioTracks()[0].enabled = !currentStatus;\n      return !currentStatus;\n    });\n  };\n\n  \n    //SCREEN SHARING \n    const handleScreenSharing = () => {\n\n      if(!myVdoStatus){\n        message.error(\"Turn on your video to share the content\", 2);\n        return;\n      }\n    \n      if (!screenShare) {\n        navigator.mediaDevices\n          .getDisplayMedia({ cursor: true })\n          .then((currentStream) => {\n            const screenTrack = currentStream.getTracks()[0];\n\n  \n              // replaceTrack (oldTrack, newTrack, oldStream);\n              connectionRef.current.replaceTrack(\n                connectionRef.current.streams[0]\n                  .getTracks()\n                  .find((track) => track.kind === 'video'),\n                screenTrack,\n                stream\n              );\n  \n            // Listen click end\n            screenTrack.onended = () => {\n              connectionRef.current.replaceTrack(\n                  screenTrack,\n                  connectionRef.current.streams[0]\n                    .getTracks()\n                    .find((track) => track.kind === 'video'),\n                  stream\n                );\n\n              myVideo.current.srcObject = stream;\n              setScreenShare(false);\n            };\n  \n            myVideo.current.srcObject = currentStream;\n            screenTrackRef.current = screenTrack;\n            setScreenShare(true);\n          }).catch((error) => {\n            console.log(\"No stream for sharing\")\n          });\n      } else {\n        screenTrackRef.current.onended();\n      }\n    };\n\n     //full screen\n     const fullScreen = (e) => {\n      const elem = e.target;\n  \n      if (elem.requestFullscreen) {\n        elem.requestFullscreen();\n      } else if (elem.mozRequestFullScreen) {\n        /* Firefox */\n        elem.mozRequestFullScreen();\n      } else if (elem.webkitRequestFullscreen) {\n        /* Chrome, Safari & Opera */\n        elem.webkitRequestFullscreen();\n      } else if (elem.msRequestFullscreen) {\n        /* IE/Edge */\n        elem.msRequestFullscreen();\n      }\n    };\n\n  const leaveCall = () => {\n    setCallEnded(true);\n\n    connectionRef.current.destroy();\n    socket.emit(\"endCall\", { id: otherUser });\n    window.location.reload();\n  };\n\n  const leaveCall1 = () => {\n    socket.emit(\"endCall\", { id: otherUser });\n  };\n  const sendMsg = (value) => {\n    socket.emit(\"msgUser\", { name, to: otherUser, msg: value, sender: name });\n    let msg = {};\n    msg.msg = value;\n    msg.type = \"sent\";\n    msg.timestamp = Date.now();\n    msg.sender = name;\n    setChat([...chat, msg]);\n  };\n\n  return (\n    <VideoContext.Provider\n      value={{\n        call,\n        callAccepted,\n        myVideo,\n        userVideo,\n        stream,\n        name,\n        setName,\n        callEnded,\n        me,\n        callUser,\n        leaveCall,\n        answerCall,\n        sendMsg,\n        msgRcv,\n        chat,\n        setChat,\n        setMsgRcv,\n        setOtherUser,\n        leaveCall1,\n        userName,\n        myVdoStatus,\n        setMyVdoStatus,\n        userVdoStatus,\n        setUserVdoStatus,\n        updateVideo,\n        myMicStatus,\n        userMicStatus,\n        updateMic,\n        screenShare,\n        handleScreenSharing,\n        fullScreen\n      }}\n    >\n      {children}\n    </VideoContext.Provider>\n  );\n};\n\nexport default VideoState;\n"]},"metadata":{},"sourceType":"module"}